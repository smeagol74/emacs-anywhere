#!/bin/bash

function debug() {
    MSG=$1
    TITLE=$2
    SCRIPT="display notification \"${MSG}\""
    if [ -n "$TITLE" ]; then
        SCRIPT="${SCRIPT} with title \"${TITLE}\""
    fi
    osascript -e "${SCRIPT}"
}

cat > ~/tmp/ea_app_name.applescript <<EOF
tell application "System Events" to set frontApp to name of first process whose frontmost is true

return frontApp
EOF

export EA_APP_NAME=$( osascript ~/tmp/ea_app_name.applescript )

cat > ~/tmp/ea_window_title.applescript <<EOF
set frontApp to "${EA_APP_NAME}"

tell application frontApp to set windowTitle to name of front window

return windowTitle
EOF

export EA_WINDOW_TITLE=$( osascript ~/tmp/ea_window_title.applescript )

cat > ~/tmp/ea_browser.applescript <<EOF
set frontApp to "${EA_APP_NAME}"

if (frontapp starts with "Google Chrome") or (frontApp starts with "Chromium") or (frontApp starts with "Opera") or (frontApp starts with "Vivaldi") or (frontApp starts with "Brave Browser") or (frontApp starts with "Microsoft Edge") then
  using terms from application "Google Chrome"
    tell application frontApp to set currentTabUrl to URL of active tab of front window
  end using terms from
else if (frontApp starts with "Safari") or (frontApp starts with "Webkit") then
  using terms from application "Safari"
    tell application frontApp to set currentTabUrl to URL of front document
  end using terms from
else
  set currentTabUrl to ""
end if

return currentTabUrl
EOF

export EA_BROWSER_URL=$( osascript ~/tmp/ea_browser.applescript )

cat > ~/tmp/ea_tgeo.applescript <<EOF
tell application "System Events"
  set frontWindow to front window of (first application process whose frontmost is true)
  set windowPosition to (get position of frontWindow)
  set windowSize to (get size of frontWindow)
end tell

return windowPosition & windowSize
EOF

EA_TGEO=$( osascript ~/tmp/ea_tgeo.applescript )
if [ $? -ne 0 ]; then
    EA_TGEO="0, 0, 0, 0"
fi
IFS=', ' read -r -a EA_GEO <<< "$EA_TGEO"

cat > ~/tmp/ea_config.txt <<EOF
app: ${EA_APP_NAME}
title: ${EA_WINDOW_TITLE}
url: ${EA_BROWSER_URL}
geo: ${EA_TGEO}
EOF

export EA_X="${EA_GEO[0]}"
export EA_Y="${EA_GEO[1]}"
export EA_WIDTH="${EA_GEO[2]}"
export EA_HEIGHT="${EA_GEO[3]}"

$HOME/.emacs_anywhere/bin/emacstask

if [ ! -f /tmp/eaenv ]; then
    exit 1
fi
source /tmp/eaenv
rm /tmp/eaenv

if [ "$EA_ABORT" = true ]; then
    exit 0;
fi

cat > ~/tmp/ea_activate.applescript <<EOF
tell application "$EA_APP_NAME" to activate

EOF


if [ "$EA_SHOULD_PASTE" = true ]; then
cat >> ~/tmp/ea_activate.applescript <<EOF
tell application "System Events" to keystroke "v" using command down
EOF
fi

osascript ~/tmp/ea_activate.applescript
